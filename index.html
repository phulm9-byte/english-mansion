
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>English Mansion v8.5 - Final Master</title>
    <style>
      :root {
        --c-50: #eefbfd;
        --c-100: #d4f4f9;
        --c-200: #aee9f3;
        --c-300: #76d8ea;
        --c-400: #37bdd9;
        --c-500: #1ba0bf;
        --c-600: #1981a1;
        --c-700: #1b6883;
        --c-800: #1f566b;
        --c-900: #1e475b;
        --c-950: #11384b;

        --primary: var(--c-500);
        --secondary: #22c55e;
        --gold: #f59e0b;
        --danger: #ef4444;
        --bg: var(--c-50);
        --text: var(--c-950);
        --shadow: 0 10px 25px -5px rgba(27, 160, 191, 0.2);
      }

      * {
        box-sizing: border-box;
        font-family: "Segoe UI", Roboto, sans-serif;
        outline: none;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        padding-bottom: 90px;
        overflow-x: hidden;
        touch-action: manipulation;
      }

      header {
        position: fixed;
        top: 0;
        width: 100%;
        background: linear-gradient(135deg, var(--c-700), var(--c-500));
        color: white;
        padding: 18px 15px;
        z-index: 1000;
        text-align: center;
        box-shadow: var(--shadow);
        border-bottom: 1px solid var(--c-300);
        border-radius: 0 0 24px 24px;
        animation: slideDown 0.5s ease-out;
      }

      @keyframes slideDown {
        from {
          transform: translateY(-100%);
        }
        to {
          transform: translateY(0);
        }
      }

      .stats {
        display: flex;
        justify-content: center;
        gap: 15px;
        font-size: 13px;
        margin-top: 8px;
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 15px;
        border-radius: 20px;
        width: fit-content;
        margin-left: auto;
        margin-right: auto;
        transition: transform 0.3s;
      }
      .stats:hover {
        transform: scale(1.05);
      }

      nav {
        position: fixed;
        bottom: 0;
        width: 100%;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        display: flex;
        border-top: 1px solid var(--c-200);
        z-index: 1000;
        padding: 8px;
      }

      nav button {
        flex: 1;
        padding: 10px 5px;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: bold;
        color: var(--c-700);
        font-size: 10px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 14px;
      }

      nav button.active {
        color: white;
        background: var(--c-500);
        box-shadow: 0 4px 12px rgba(27, 160, 191, 0.4);
        transform: translateY(-5px);
      }

      main {
        padding: 140px 20px 20px;
        max-width: 600px;
        margin: auto;
      }

      .section {
        display: none;
        animation: sectionIn 0.5s cubic-bezier(0.23, 1, 0.32, 1) forwards;
      }
      .section.active {
        display: block;
      }

      @keyframes sectionIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .box {
        background: white;
        padding: 25px;
        border-radius: 24px;
        text-align: center;
        box-shadow: var(--shadow);
        margin-bottom: 25px;
        border: 1px solid var(--c-100);
        transition: transform 0.3s ease;
      }
      .box:hover {
        transform: translateY(-2px);
      }

      .topic-select {
        width: 100%;
        padding: 14px;
        border-radius: 16px;
        border: 2px solid var(--c-200);
        font-size: 16px;
        font-weight: bold;
        color: var(--c-800);
        background: var(--c-50);
        cursor: pointer;
        transition: all 0.3s;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%231b6883' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 15px center;
        background-size: 15px;
      }
      .topic-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px var(--c-100);
      }

      .flash-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 18px;
      }

      .card-3d {
        height: 150px;
        perspective: 1000px;
        cursor: pointer;
      }
      .card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        transform-style: preserve-3d;
      }
      .card-inner.flip {
        transform: rotateY(180deg);
      }

      .card-front,
      .card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 20px;
        border: 1px solid var(--c-100);
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
      }

      .card-front {
        background: white;
        color: var(--c-700);
        font-weight: bold;
      }
      .card-back {
        background: linear-gradient(135deg, var(--c-500), var(--c-700));
        color: white;
        transform: rotateY(180deg);
      }

      .game-card {
        background: white;
        padding: 20px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 18px;
        cursor: pointer;
        border: 1px solid var(--c-100);
        margin-bottom: 15px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .game-card:hover {
        transform: translateX(8px);
        border-color: var(--c-400);
        box-shadow: var(--shadow);
      }
      .game-card:active {
        transform: scale(0.95);
      }

      .btn-main {
        background: linear-gradient(to right, var(--c-500), var(--c-600));
        color: white;
        border: none;
        padding: 15px;
        border-radius: 15px;
        width: 100%;
        cursor: pointer;
        font-weight: bold;
        font-size: 16px;
        transition: all 0.3s;
        box-shadow: 0 6px 15px rgba(27, 160, 191, 0.3);
      }
      .btn-main:hover {
        opacity: 0.9;
        transform: translateY(-2px);
      }
      .btn-main:active {
        transform: scale(0.97);
      }

      #btn-check,
      #btn-next {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(27, 160, 191, 0.4);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(27, 160, 191, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(27, 160, 191, 0);
        }
      }

      .house {
        width: 100%;
        height: 350px;
        border-radius: 28px;
        position: relative;
        background: white;
        border: 6px solid white;
        overflow: hidden;
        box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.05), var(--shadow);
        background-image: radial-gradient(var(--c-100) 10%, transparent 10%),
          radial-gradient(var(--c-100) 10%, transparent 10%);
        background-size: 20px 20px;
        background-position: 0 0, 10px 10px;
        transition: all 0.5s ease;
      }

      .item {
        position: absolute;
        font-size: 50px;
        cursor: move;
        z-index: 10;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.1s linear;
      }
      .item:active {
        transform: scale(1.2);
      }

      /* Tinh ch·ªânh ri√™ng cho √¥ nh·∫≠p t√™n trong H·ªì s∆° */
      #user-name {
        display: block;
        width: 100%;
        max-width: 250px;
        margin: 20px auto;
        padding: 12px 20px;
        border: 2px solid var(--c-200);
        border-radius: 15px;
        font-size: 18px;
        font-weight: bold;
        color: var(--c-700);
        background: var(--c-50);
        text-align: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      #user-name:focus {
        border-color: var(--primary);
        background: white;
        box-shadow: 0 0 0 4px var(--c-100), 0 4px 12px rgba(27, 160, 191, 0.1);
        transform: translateY(-2px);
        outline: none;
      }

      #user-name::placeholder {
        color: var(--c-300);
        font-weight: normal;
        font-style: italic;
      }

      /* Th√™m hi·ªáu ·ª©ng cho thanh XP trong h·ªì s∆° */
      #prof-xp {
        transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1);
        background: linear-gradient(
          90deg,
          var(--secondary),
          #4ade80
        ) !important;
        box-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
      }

      .inv-item {
        font-size: 32px;
        background: var(--c-100);
        padding: 12px;
        border-radius: 18px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border: 2px solid transparent;
      }
      .inv-item:hover {
        background: var(--c-200);
        border-color: var(--c-400);
        transform: scale(1.1) rotate(5deg);
      }

      #g-msg {
        animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      @keyframes bounceIn {
        from {
          opacity: 0;
          transform: scale(0.8);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* Custom Scrollbar */
      #inv-list::-webkit-scrollbar {
        height: 6px;
      }
      #inv-list::-webkit-scrollbar-thumb {
        background: var(--c-300);
        border-radius: 10px;
      }
      /* --- GI·ªÆ NGUY√äN STYLE 8.5 - CH·ªà ƒê·ªîI M√ÄU CYAN --- */

      .menu-board {
        background: #f0fdff; /* Cyan c·ª±c nh·∫π thay cho m√†u v√†ng c≈© */
        border: 2px dashed var(--c-400); /* N√©t ƒë·ª©t m√†u Cyan */
        padding: 12px;
        border-radius: 15px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
      }

      .order-list {
        display: flex;
        justify-content: center;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 5px;
      }

      .order-item {
        padding: 4px 8px;
        background: white;
        border-radius: 6px;
        font-size: 11px;
        border: 1px solid var(--c-200);
        color: var(--c-700);
        font-weight: 600;
      }

      .order-item.done {
        background: var(--secondary);
        color: white;
        text-decoration: line-through;
        border-color: var(--secondary);
        box-shadow: 0 2px 4px rgba(34, 197, 94, 0.2);
      }

      .drop-zone {
        width: 90px;
        height: 90px;
        border: 3px dashed var(--c-300);
        margin: 15px auto;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        background: var(--c-50);
        transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      .drop-zone.hover {
        background: var(--c-100);
        border-color: var(--primary);
        transform: scale(1.1);
      }

      .ingredients {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        padding: 10px;
        background: var(--c-100); /* M√†u n·ªÅn khu v·ª±c nguy√™n li·ªáu */
        border-radius: 15px;
        border: 1px solid var(--c-200);
      }

      .drag-word {
        padding: 10px 15px;
        background: var(--primary);
        color: white;
        border-radius: 10px;
        cursor: grab;
        font-weight: bold;
        box-shadow: 0 3px 6px rgba(27, 160, 191, 0.2);
        transition: all 0.2s;
      }

      .drag-word:active {
        cursor: grabbing;
        transform: scale(0.95);
        opacity: 0.8;
      }

      /* Ki·ªÉu d√°ng cho c√°c Game Card ch·ªçn ch·∫ø ƒë·ªô */
      .game-card {
        background: white;
        padding: 15px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        cursor: pointer;
        border: 1px solid var(--c-100);
        margin-bottom: 10px;
        text-align: left;
        transition: 0.3s ease;
      }

      .game-card:hover {
        border-color: var(--c-400);
        background: var(--c-50);
        transform: translateX(5px);
      }
      /* --- GI·ªÆ NGUY√äN STYLE 8.5 CHO 3 GAME C√íN L·∫†I - CH·ªà ƒê·ªîI M√ÄU --- */

      /* Ti√™u ƒë·ªÅ c√¢u h·ªèi trong Standard UI */
      #g-title {
        color: var(--c-800);
        font-size: 1.2rem;
        margin-bottom: 15px;
        font-weight: 700;
      }

      /* Khu v·ª±c ch·ª©a t·ª´ ti·∫øng Vi·ªát v√† t·ª´ g·ª£i √Ω */
      #g-content p {
        font-size: 16px;
        color: #64748b; /* M√†u x√°m slate nh·∫π c·ªßa v8.5 */
        margin-bottom: 5px;
      }

      /* --- ƒê·ªîI ƒê·ªÄ B√ÄI T·ª™ IN HOA SANG IN TH∆Ø·ªúNG --- */
      #g-content h2 {
        letter-spacing: 2px; /* Gi·∫£m spacing m·ªôt ch√∫t cho ch·ªØ th∆∞·ªùng d·ªÖ ƒë·ªçc */
        color: var(--primary);
        font-size: 26px;
        margin-top: 5px;

        /* Thay ƒë·ªïi quan tr·ªçng nh·∫•t ·ªü ƒë√¢y */
        text-transform: lowercasc; /* √âp t·∫•t c·∫£ v·ªÅ ch·ªØ th∆∞·ªùng */

        /* N·∫øu b·∫°n mu·ªën vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu ti√™n thay v√¨ ch·ªØ th∆∞·ªùng h·∫øt, 
           h√£y d√πng: text-transform: capitalize; */

        text-shadow: 1px 1px 0 var(--c-100);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; /* Font m·ªÅm m·∫°i h∆°n cho ch·ªØ th∆∞·ªùng */
      }

      /* √î nh·∫≠p ƒë√°p √°n - Gi·ªØ nguy√™n ki·ªÉu v8.5 */
      input#ans {
        display: none; /* Logic v8.5 t·ª± hi·ªán khi v√†o game */
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        border-radius: 10px;
        border: 1px solid var(--c-200);
        font-size: 18px;
        text-align: center;
        background: white;
        color: var(--c-800);
        transition: border-color 0.3s, box-shadow 0.3s;
      }

      input#ans:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--c-100);
        outline: none;
      }

      /* N√∫t Ki·ªÉm tra v√† Ti·∫øp theo */
      .btn-main {
        background: var(
          --secondary
        ); /* V·∫´n gi·ªØ m√†u xanh l√° ƒë·∫∑c tr∆∞ng cho n√∫t Check */
        color: white;
        border: none;
        padding: 12px;
        border-radius: 12px;
        width: 100%;
        cursor: pointer;
        font-weight: bold;
        margin-top: 10px;
        font-size: 16px;
        transition: transform 0.2s, opacity 0.2s;
      }

      .btn-main:active {
        transform: scale(0.98);
        opacity: 0.9;
      }

      /* Th√¥ng b√°o ƒê√∫ng/Sai - M√†u s·∫Øc v8.5 tr√™n n·ªÅn Cyan */
      #g-msg {
        margin-top: 15px;
        padding: 12px;
        border-radius: 10px;
        display: none;
        font-weight: 600;
        font-size: 14px;
        text-align: center;
      }

      /* N√∫t Ti·∫øp theo trong Standard UI */
      #btn-next {
        background: var(
          --primary
        ) !important; /* ƒê·ªïi sang m√†u Cyan cho n√∫t Next */
      }

      /* Hi·ªáu ·ª©ng tr∆∞·ª£t nh·∫π khi n·ªôi dung game xu·∫•t hi·ªán */
      #standard-ui {
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
    </style>
  </head>
  <body>
    <div
      style="
        margin-bottom: 20px;
        background: var(--c-50);
        padding: 15px;
        border-radius: 10px;
        border: 1px solid var(--c-300);
      "
    >
      <label style="font-weight: bold; color: var(--primary)"
        >üéØ Ch·ªçn ƒë·ªô kh√≥ th·ª±c ƒë∆°n:</label
      >
      <select
        id="difficulty-select"
        onchange="gameDifficulty = parseInt(this.value)"
        style="
          width: 100%;
          padding: 8px;
          margin-top: 10px;
          border-radius: 5px;
          border: 1px solid var(--c-300);
        "
      >
        <option value="3">D·ªÖ (3 m√≥n)</option>
        <option value="5" selected>Trung b√¨nh (5 m√≥n)</option>
        <option value="8">Kh√≥ (8 m√≥n)</option>
        <option value="12">Si√™u ƒë·∫ßu b·∫øp (12 m√≥n)</option>
      </select>
    </div>
    <audio
      id="snd-correct"
      src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"
    ></audio>
    <audio
      id="snd-wrong"
      src="https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3"
    ></audio>

    <header>
      <h1>English Mansion</h1>
      <div class="stats">
        üí∞ <span id="u-coins">0</span> | ‚≠ê Lv <span id="u-lv">1</span>
      </div>
    </header>

    <main>
      <section id="sec-flash" class="section active">
        <div class="box">
          <h4>Ch·ªß ƒë·ªÅ h·ªçc t·∫≠p</h4>
          <select
            id="flash-topic-select"
            class="topic-select"
            onchange="changeTopic(this.value)"
          ></select>
        </div>
        <div class="flash-grid" id="flash-list"></div>
      </section>

      <section id="sec-game" class="section">
        <div id="game-menu">
          <div class="box">
            <h4>Ch·ªçn ch·ªß ƒë·ªÅ ch∆°i</h4>
            <select
              id="game-topic-select"
              class="topic-select"
              onchange="changeTopic(this.value)"
            ></select>
          </div>
          <div
            class="game-card"
            onclick="startGame('cook')"
            style="border: 2px solid var(--gold)"
          >
            <span style="font-size: 30px">üë®‚Äçüç≥</span>
            <div>
              <b>ƒê·∫ßu b·∫øp Master</b><br /><small
                >Th·ª±c ƒë∆°n Tr√°i c√¢y & ·∫®m th·ª±c (K√©o th·∫£)</small
              >
            </div>
          </div>
          <div class="game-card" onclick="startGame('scramble')">
            <span>üîÄ</span> <b>S·∫Øp x·∫øp ch·ªØ</b>
          </div>
          <div class="game-card" onclick="startGame('missing')">
            <span>‚ùì</span> <b>ƒêi·ªÅn k√Ω t·ª±</b>
          </div>
          <div class="game-card" onclick="startGame('translate')">
            <span>üáªüá≥</span> <b>D·ªãch thu·∫≠t</b>
          </div>
        </div>

        <div id="game-play" style="display: none" class="box">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 15px;
            "
          >
            <button onclick="exitToMenu()">‚¨Ö</button>
            <span id="g-progress">0/0</span>
          </div>
          <div id="chef-ui" style="display: none">
            <div class="menu-board">
              <small>üìù TH·ª∞C ƒê∆†N:</small>
              <div class="order-list" id="order-list"></div>
            </div>
            <div class="drop-zone" id="drop-zone">üçΩÔ∏è</div>
            <h3 id="chef-target-vi">M√≥n ƒÉn</h3>
            <div class="ingredients" id="ingredients"></div>
          </div>
          <div id="standard-ui">
            <h3 id="g-title">Game</h3>
            <div id="g-content"></div>
            <input id="ans" autocomplete="off" placeholder="Nh·∫≠p ƒë√°p √°n..." />
            <button id="btn-check" class="btn-main" onclick="checkStandard()">
              Ki·ªÉm tra
            </button>
          </div>
          <div
            id="g-msg"
            style="
              margin-top: 15px;
              padding: 12px;
              border-radius: 10px;
              display: none;
            "
          ></div>
          <button
            id="btn-next"
            class="btn-main"
            style="display: none; background: var(--primary)"
            onclick="nextLevel()"
          >
            Ti·∫øp theo ‚û°
          </button>
        </div>
      </section>

      <section id="sec-shop" class="section">
        <div class="box"><h4>üõí C·ª≠a h√†ng n·ªôi th·∫•t</h4></div>
        <div class="flash-grid" id="shop-list"></div>
      </section>

      <section id="sec-home" class="section">
        <div
          class="box"
          style="
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <b>üè† Nh√† c·ªßa t√¥i</b>
          <button
            id="btn-mode"
            onclick="toggleRemoveMode()"
            style="
              background: var(--gold);
              border: none;
              padding: 8px 15px;
              color: white;
              border-radius: 8px;
              cursor: pointer;
            "
          >
            üóëÔ∏è C·∫•t ƒë·ªì
          </button>
        </div>
        <div class="house" id="house-view"></div>
        <div class="box" style="margin-top: 10px; padding: 10px">
          <small>KHO ƒê·ªí (Nh·∫•n ƒë·ªÉ ƒë·∫∑t v√†o nh√†)</small>
          <div
            id="inv-list"
            style="display: flex; gap: 10px; overflow-x: auto; padding: 10px"
          ></div>
        </div>
      </section>

      <section id="sec-profile" class="section">
        <div class="box">
          <div style="font-size: 60px">üë§</div>
          <input
  type="text"
  id="user-name"
  placeholder="T√™n c·ªßa b·∫°n..."
  onkeydown="if(event.key==='Enter') updateProfile()"
  onblur="updateProfile()"
  style="display: block"
/>
          <p>C·∫•p ƒë·ªô: <b id="prof-lv">1</b></p>
          <div
            style="
              background: #e2e8f0;
              height: 12px;
              border-radius: 10px;
              overflow: hidden;
            "
          >
            <div
              id="prof-xp"
              style="background: var(--secondary); height: 100%; width: 0%"
            ></div>
          </div>
        </div>
      </section>
    </main>

    <nav>
      <button onclick="show('sec-flash', this)" class="active">üé¥ H·ªåC</button>
      <button onclick="show('sec-game', this)">üéÆ CH∆†I</button>
      <button onclick="show('sec-shop', this)">üõí SHOP</button>
      <button onclick="show('sec-home', this)">üè† NH√Ä</button>
      <button onclick="show('sec-profile', this)">üë§ H·ªí S∆†</button>
    </nav>

    <script>
      // --- C·∫•u h√¨nh d·ªØ li·ªáu ch·ªß ƒë·ªÅ ---
      let topicsData = [];

function loadTopicsFromSheet() {
  fetch("https://script.google.com/macros/s/AKfycbzLraIHckXKXFnF2tpS82fFdf6dUKNuy3Erm3PChWRUlUQQf6JdBaEUP2cEZDbyJeJF/exec")
    .then(res => res.json())
    .then(data => {
      topicsData = data;
      updateTopicDisplay(); // gi·ªØ nguy√™n logic c≈©
    })
    .catch(err => {
      console.error(err);
      alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu t·ª´ Google Sheet");
    });
}
      // --- Tr·∫°ng th√°i tr√≤ ch∆°i ---
      let state = JSON.parse(localStorage.getItem("MansionFinal")) || {
        name: "",
        coins: 100,
        lv: 1,
        xp: 0,
        inventory: [],
        placed: [],
      };

      let topicIdx = 0,
        mastered = [],
        currentType = "",
        chefOrders = [],
        chefIdx = 0,
        currentCorrect = "",
        isRemoveMode = false;

      // --- H√†m H·ªá Th·ªëng ---
     function syncUserToSheet() {
  if (!state.name) return;

  fetch("https://script.google.com/macros/s/AKfycbzLraIHckXKXFnF2tpS82fFdf6dUKNuy3Erm3PChWRUlUQQf6JdBaEUP2cEZDbyJeJF/exec", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      id: localStorage.getItem("USER_ID") || createUserId(),
      name: state.name,
      lv: state.lv,
      coins: state.coins
    })
  })
  .then(() => console.log("‚úÖ ƒê√£ l∆∞u user v√†o Sheet"));
}




 function save() {
        localStorage.setItem("MansionFinal", JSON.stringify(state));
        document.getElementById("u-coins").innerText = state.coins;
        document.getElementById("u-lv").innerText = state.lv;

  syncUserToSheet();

      }


// --- t·∫°o user m·ªôt l·∫ßn duy nh·∫•t ---
function createUserId() {
  const id = "U" + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
  localStorage.setItem("USER_ID", id);
  return id;
}

      function show(id, btn) {
        document
          .querySelectorAll(".section")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        document
          .querySelectorAll("nav button")
          .forEach((b) => b.classList.remove("active"));
        if (btn) btn.classList.add("active");
        if (id === "sec-profile") updateProfileUI();
        if (id === "sec-home") renderHome();
        if (id === "sec-shop") renderShop();
      }

      // --- Logic H·ªçc T·∫≠p & Flashcard ---
      function updateTopicDisplay() {
        const options = topicsData
          .map(
            (t, i) =>
              `<option value="${i}" ${i == topicIdx ? "selected" : ""}>${
                t.name
              }</option>`
          )
          .join("");
        document.getElementById("flash-topic-select").innerHTML = options;
        document.getElementById("game-topic-select").innerHTML = options;
        renderFlash();
      }

      function changeTopic(val) {
        topicIdx = parseInt(val);
        updateTopicDisplay();
      }

      function renderFlash() {
  const list = document.getElementById("flash-list");
  const words = topicsData[topicIdx].words;

  let html = "";
  for (const w of words) {
    html += `
      <div class="card-3d"
        onclick="this.querySelector('.card-inner').classList.toggle('flip'); speak('${w.en}')">
        <div class="card-inner">
          <div class="card-front">
            <span style="font-size:35px">${w.icon}</span>${w.en}
          </div>
          <div class="card-back"><b>${w.vi}</b></div>
        </div>
      </div>`;
  }

  list.innerHTML = html;
}

      // --- Mini Games ---
      function startGame(type) {
        currentType = type;
        mastered = [];
        document.getElementById("game-menu").style.display = "none";
        document.getElementById("game-play").style.display = "block";
        nextLevel();
      }

      function nextLevel() {
        document.getElementById("g-msg").style.display = "none";
        document.getElementById("btn-next").style.display = "none";

        if (currentType === "cook") {
          document.getElementById("chef-ui").style.display = "block";
          document.getElementById("standard-ui").style.display = "none";

          // --- C·∫¨P NH·∫¨T: T·∫†O TH·ª∞C ƒê∆†N D·ª∞A TR√äN LV ---
          if (chefIdx === 0 || chefIdx >= chefOrders.length) {
            const pool = topicsData
              .filter((t) =>
                ["fruits", "cooking", "drinks", "bakery"].includes(t.key)
              )
              .flatMap((t) => t.words);

            // S·ªë l∆∞·ª£ng m√≥n: LV1-2: 3 m√≥n | LV3-4: 4 m√≥n | LV5-6: 5 m√≥n... T·ªëi ƒëa 12 m√≥n.
            const dynamicCount = Math.min(3 + Math.floor(state.lv / 2), 12);
            chefOrders = [...pool]
              .sort(() => 0.5 - Math.random())
              .slice(0, dynamicCount);
            chefIdx = 0;
          }
          renderChef();
        } else {
          document.getElementById("chef-ui").style.display = "none";
          document.getElementById("standard-ui").style.display = "block";
          document.getElementById("ans").style.display = "block";
          document.getElementById("btn-check").style.display = "block";
          renderStandard();
        }
      }

      function renderChef() {
        const target = chefOrders[chefIdx];
        document.getElementById("g-progress").innerText = `Th·ª±c ƒë∆°n: ${
          chefIdx + 1
        }/${chefOrders.length}`;
        document.getElementById("chef-target-vi").innerText = target.vi;
        document.getElementById("drop-zone").innerText = "üçΩÔ∏è";

        const list = document.getElementById("order-list");
        list.innerHTML = chefOrders
          .map(
            (o, i) =>
              `<div class="order-item ${i < chefIdx ? "done" : ""}">${
                o.vi
              }</div>`
          )
          .join("");

        const pool = topicsData
          .filter((t) => ["fruits", "cooking"].includes(t.key))
          .flatMap((t) => t.words);
        let options = [
          target,
          ...pool
            .filter((p) => p.en !== target.en)
            .sort(() => 0.5 - Math.random())
            .slice(0, 3),
        ];
        options.sort(() => 0.5 - Math.random());

        const ing = document.getElementById("ingredients");
        ing.innerHTML = "";
        options.forEach((opt) => {
          const el = document.createElement("div");
          el.className = "drag-word";
          el.innerText = opt.en;
          el.draggable = true;
          el.ondragstart = (e) => e.dataTransfer.setData("text", opt.en);
          ing.appendChild(el);
        });

        const zone = document.getElementById("drop-zone");
        zone.ondragover = (e) => {
          e.preventDefault();
          zone.classList.add("hover");
        };
        zone.ondragleave = () => zone.classList.remove("hover");
        zone.ondrop = (e) => {
          e.preventDefault();
          zone.classList.remove("hover");
          if (e.dataTransfer.getData("text") === target.en) {
            document.getElementById("snd-correct").play();
            zone.innerText = target.icon;
            chefIdx++;
            state.coins += 25;
            save();
            if (chefIdx >= chefOrders.length)
              setTimeout(
                () =>
                  finish(
                    `Tuy·ªát v·ªùi! Th·ª±c ƒë∆°n ${chefOrders.length} m√≥n ho√†n t·∫•t!`
                  ),
                800
              );
            else setTimeout(nextLevel, 800);
          } else {
            document.getElementById("snd-wrong").play();
            showMsg("Sai nguy√™n li·ªáu r·ªìi!", "danger");
          }
        };
      }

      function renderStandard() {
        const pool = topicsData[topicIdx].words;
        const rem = pool.filter((w) => !mastered.includes(w.en));
        if (rem.length === 0) {
          finish("Xu·∫•t s·∫Øc! B·∫°n ƒë√£ thu·ªôc h·∫øt ch·ªß ƒë·ªÅ n√†y!");
          return;
        }
        const target = rem[Math.floor(Math.random() * rem.length)];
        currentCorrect = target.en;
        document.getElementById(
          "g-progress"
        ).innerText = `Ti·∫øn ƒë·ªô: ${mastered.length}/${pool.length}`;
        document.getElementById("ans").value = "";

        let prompt = "";
        if (currentType === "scramble")
          prompt = target.en
            .split("")
            .sort(() => 0.5 - Math.random())
            .join("");
        else if (currentType === "missing")
          prompt = target.en
            .split("")
            .map((c, i) => (i % 2 == 0 ? c : "_"))
            .join("");
        else prompt = "D·ªãch sang ti·∫øng Anh";

        document.getElementById(
          "g-content"
        ).innerHTML = `<p>${target.vi}</p><h2 style="letter-spacing:4px; color:var(--primary)">${prompt}</h2>`;
      }

      function checkStandard() {
        const val = document.getElementById("ans").value.trim().toLowerCase();
        if (val === currentCorrect.toLowerCase()) {
          document.getElementById("snd-correct").play();
          showMsg("Ch√≠nh x√°c! +30 Xu", "success");
          mastered.push(currentCorrect);
          state.coins += 30;
          state.xp += 20;
          if (state.xp >= 100) {
            state.lv++;
            state.xp = 0;
          }
        } else {
          document.getElementById("snd-wrong").play();
          showMsg("Ch∆∞a ƒë√∫ng! ƒê√°p √°n: " + currentCorrect, "danger");
        }
        save();
        document.getElementById("btn-check").style.display = "none";
        document.getElementById("btn-next").style.display = "block";
      }

      function showMsg(txt, type) {
        const m = document.getElementById("g-msg");
        m.innerText = txt;
        m.style.display = "block";
        m.style.background = type === "success" ? "#dcfce7" : "#fee2e2";
        m.style.color = type === "success" ? "#166534" : "#991b1b";
      }

      function finish(txt) {
        document.getElementById("chef-ui").style.display = "none";
        document.getElementById("standard-ui").style.display = "block";
        document.getElementById("ans").style.display = "none";
        document.getElementById("btn-check").style.display = "none";
        document.getElementById("g-content").innerHTML = `<h2>üéâ ${txt}</h2>`;
        setTimeout(exitToMenu, 2500);
      }

      function exitToMenu() {
        document.getElementById("game-menu").style.display = "block";
        document.getElementById("game-play").style.display = "none";
        chefOrders = [];
        chefIdx = 0;
      }

      function renderShop() {
        const list = document.getElementById("shop-list");
        list.innerHTML = shopItems
          .map(
            (item) => `
      <div class="box">
        <div style="font-size:40px">${item.i}</div>
        <b>${item.n}</b><br>
        <small>${item.p} Xu</small>
        <button class="btn-main" onclick="buyItem(${item.id})">Mua</button>
      </div>`
          )
          .join("");
      }

      function buyItem(id) {
        const it = shopItems.find((x) => x.id === id);
        if (state.coins >= it.p) {
          state.coins -= it.p;
          state.inventory.push({ icon: it.i });
          save();
          alert("ƒê√£ mua th√†nh c√¥ng!");
        } else alert("B·∫°n kh√¥ng ƒë·ªß xu!");
      }

      function toggleRemoveMode() {
        isRemoveMode = !isRemoveMode;
        const btn = document.getElementById("btn-mode");
        btn.innerText = isRemoveMode ? "‚úÖ Xong" : "üóëÔ∏è C·∫•t ƒë·ªì";
        btn.style.background = isRemoveMode
          ? "var(--secondary)"
          : "var(--gold)";
        renderHome();
      }

      function renderHome() {
        const h = document.getElementById("house-view");
        h.innerHTML = "";
        state.placed.forEach((it, i) => {
          const el = document.createElement("div");
          el.className = "item";
          el.innerText = it.icon;
          el.style.left = it.x + "px";
          el.style.top = it.y + "px";

          if (isRemoveMode) {
            el.style.cursor = "pointer";
            el.style.border = "2px dashed red";
            el.onclick = () => {
              state.inventory.push({ icon: it.icon });
              state.placed.splice(i, 1);
              save();
              renderHome();
            };
          } else {
            const handleMove = (cx, cy) => {
              const r = h.getBoundingClientRect();
              const itemSize = 50;
              let nX = cx - r.left - itemSize / 2;
              let nY = cy - r.top - itemSize / 2;
              nX = Math.max(0, Math.min(nX, r.width - itemSize));
              nY = Math.max(0, Math.min(nY, r.height - itemSize));
              it.x = nX;
              it.y = nY;
              el.style.left = nX + "px";
              el.style.top = nY + "px";
            };
            el.onmousedown = (e) => {
              e.preventDefault();
              document.onmousemove = (ev) => handleMove(ev.clientX, ev.clientY);
              document.onmouseup = () => {
                document.onmousemove = null;
                save();
              };
            };
          }
          h.appendChild(el);
        });

        const inv = document.getElementById("inv-list");
        inv.innerHTML = "";
        state.inventory.forEach((it, i) => {
          const d = document.createElement("div");
          d.className = "inv-item";
          d.innerText = it.icon;
          d.onclick = () => {
            state.placed.push({ icon: it.icon, x: 50, y: 50 });
            state.inventory.splice(i, 1);
            save();
            renderHome();
          };
          inv.appendChild(d);
        });
      }

      function updateProfileUI() {
        document.getElementById("user-name").value = state.name || "";
        document.getElementById("prof-lv").innerText = state.lv;
        document.getElementById("prof-xp").style.width = state.xp + "%";
      }

     function updateProfile() {
  state.name = document.getElementById("user-name").value;
  save();
  syncUserToSheet();
}

      function speak(t) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(t);
        u.lang = "en-US";
        window.speechSynthesis.speak(u);
      }

      window.onload = () => {
       
       loadTopicsFromSheet();
      };
    </script>
  </body>
</html>
